<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>បញ្ចូលទិន្នន័យសិស្ស និងថតរូប</title>
  <style>
    body {
      font-family: 'Khmer OS Battambang', sans-serif;
      background: linear-gradient(to bottom right, #e3f2fd, #ffffff);
      padding: 18px;
      margin: 0;
    }
    .container {
      max-width: 520px;
      margin: auto;
      background-color: white;
      padding: 20px 25px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    .logo {
      width: 80px;
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
      text-align: left;
    }
    input[type='text'],
    input[type='date'],
    input[type='url'],
    select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
      box-sizing: border-box;
    }
    button {
      margin-top: 25px;
      padding: 12px;
      width: 100%;
      font-size: 16px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #218838;
    }
    #message {
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
    }
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-color: rgba(255,255,255,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #overlay img {
      width: 200px;
      height: 200px;
    }
    #preview {
      margin-top: 10px;
      max-width: 100%;
      height: auto;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="moeys.png" alt="MOEYS Logo" class="logo" />
    <h2>បញ្ចូលទិន្នន័យសិស្ស និងថតរូប</h2>
    <form id="studentForm">
      <label for="STD-ID">លេខសម្គាល់ (STD-ID):</label>
      <input type="text" id="STD-ID" name="STD-ID" placeholder="STD-DDMMYY-HH-MM-SS" readonly />

      <label for="STD-NAME">ឈ្មោះសិស្ស:</label>
      <input type="text" id="STD-NAME" name="STD-NAME" required />

      <label for="STD-GENDER">ភេទ:</label>
      <select id="STD-GENDER" name="STD-GENDER" required>
        <option value="" disabled selected>-- ជ្រើសរើសភេទ --</option>
        <option value="ប្រុស">ប្រុស</option>
        <option value="ស្រី">ស្រី</option>
      </select>

      <label for="STD-DOB">ថ្ងៃខែឆ្នាំកំណើត:</label>
      <input type="date" id="STD-DOB" name="STD-DOB" required />

      <label for="STD-GRADE">ថ្នាក់ទី:</label>
      <input type="text" id="STD-GRADE" name="STD-GRADE" required />

      <label for="STD-CLASS">បន្ទប់:</label>
      <input type="text" id="STD-CLASS" name="STD-CLASS" required />

      <label for="STD-YEAR">ឆ្នាំសិក្សា:</label>
      <select id="STD-YEAR" name="STD-YEAR" required>
        <option value="" disabled selected>-- ជ្រើសរើសឆ្នាំសិក្សា --</option>
      </select>

      <label for="STD-POB">ទីកន្លែងកំណើត:</label>
      <input type="text" id="STD-POB" name="STD-POB" required />

      <label for="STD-PHONE">លេខទូរស័ព្ទ:</label>
      <input type="text" id="STD-PHONE" name="STD-PHONE" required />

      <label for="STD-ADDRESS">អាសយដ្ឋាន:</label>
      <input type="text" id="STD-ADDRESS" name="STD-ADDRESS" required />

      <label for="STD-FATHERNAME">ឈ្មោះឪពុក:</label>
      <input type="text" id="STD-FATHERNAME" name="STD-FATHERNAME" required />

      <label for="STD-FATHERJOB">មុខរបរ ឪពុក:</label>
      <input type="text" id="STD-FATHERJOB" name="STD-FATHERJOB" required />

      <label for="STD-FATHERPHONE">លេខទូរស័ព្ទឪពុក:</label>
      <input type="text" id="STD-FATHERPHONE" name="STD-FATHERPHONE" required />

      <label for="STD-MOTHERNAME">ឈ្មោះម្តាយ:</label>
      <input type="text" id="STD-MOTHERNAME" name="STD-MOTHERNAME" required />

      <label for="STD-MOTHERJOB">មុខរបរ ម្តាយ:</label>
      <input type="text" id="STD-MOTHERJOB" name="STD-MOTHERJOB" required />

      <label for="STD-MOTHERPHONE">លេខទូរស័ព្ទម្តាយ:</label>
      <input type="text" id="STD-MOTHERPHONE" name="STD-MOTHERPHONE" required />

      <label>រូបថតសិស្ស:</label>
      <input type="file" id="photoInput" accept="image/*" capture="environment" />
      <img id="preview" alt="Preview រូបថត" style="display:none;" />

      <button type="submit">បញ្ជូនទិន្នន័យ</button>
    </form>

    <div id="message"></div>
  </div>

  <div id="overlay">
    <img src="33Ho.gif" alt="Loading..." />
  </div>

  <script>
    const form = document.getElementById('studentForm');
    const message = document.getElementById('message');
    const overlay = document.getElementById('overlay');
    const preview = document.getElementById('preview');
    const photoInput = document.getElementById('photoInput');
    const idInput = document.getElementById('STD-ID');

    const cloudName = 'duymdcquj';
    const unsignedUploadPreset = 'ml_default';

    function generateID() {
      const now = new Date();
      const pad = (n) => n.toString().padStart(2, '0');
      const dd = pad(now.getDate());
      const mm = pad(now.getMonth() + 1);
      const yy = now.getFullYear().toString().slice(-2);
      const hh = pad(now.getHours());
      const mi = pad(now.getMinutes());
      const ss = pad(now.getSeconds());
      return `STD-${dd}${mm}${yy}-${hh}-${mi}-${ss}`;
    }

    idInput.value = generateID();

    // Auto-fill study years starting from 2024 to 10 years ahead
    const yearSelect = document.getElementById('STD-YEAR');
    const currentYear = new Date().getFullYear();
    const startYear = Math.max(currentYear, 2024);
    for (let y = startYear; y <= startYear + 10; y++) {
      const option = document.createElement('option');
      option.value = y;
      option.textContent = y;
      yearSelect.appendChild(option);
    }

    photoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        preview.src = reader.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    async function uploadToCloudinary(file) {
      const url = `https://api.cloudinary.com/v1_1/${cloudName}/upload`;
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', unsignedUploadPreset);

      try {
        const res = await fetch(url, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (data.secure_url) {
          return data.secure_url;
        } else {
          throw new Error('Cloudinary upload failed');
        }
      } catch (error) {
        throw error;
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      message.textContent = '';
      overlay.style.display = 'flex';

      try {
        let photoUrl = '';
        if (photoInput.files.length > 0) {
          photoUrl = await uploadToCloudinary(photoInput.files[0]);
        }

        const formData = new FormData(form);
        formData.append('STD-PHOTO-URL', photoUrl);

        const res = await fetch('https://script.google.com/macros/s/AKfycbx667r1BJqXKBPjwa8LRu_ccJeE4AjTCXoIFRLw3ID0wtTVK4YuKfuonJoJlgwW5PHY/exec', {
          method: 'POST',
          body: formData
        });

        const json = await res.json();
        overlay.style.display = 'none';

        if (json.result === 'success') {
          message.style.color = 'green';
          message.textContent = '✅ បានបញ្ចូលទិន្នន័យជោគជ័យ!';
          form.reset();
          preview.style.display = 'none';
          idInput.value = generateID();
        } else {
          message.style.color = 'red';
          message.textContent = '❌ មានបញ្ហាក្នុងការផ្ញើទិន្នន័យ: ' + json.message;
        }
      } catch (err) {
        overlay.style.display = 'none';
        message.style.color = 'red';
        message.textContent = '❌ កំហុស: ' + err.message;
      }
    });
  </script>
</body>
</html>
